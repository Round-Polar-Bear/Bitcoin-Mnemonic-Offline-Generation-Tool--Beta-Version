<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>æ¯”ç‰¹å¸åŠ©è®°è¯ç”Ÿæˆ (å®Œæ•´ä¿®å¤ç‰ˆ)</title>

<!-- å®‰å…¨å¢å¼ºï¼šç§»é™¤å¤–éƒ¨CDNå­—ä½“ä¾èµ–ï¼Œä½¿ç”¨ç³»ç»Ÿå­—ä½“ -->
<style>
:root {
  /* ç™½å¤©æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ */
  --bg-primary: #F8F9FA;
  --bg-secondary: #ffffff;
  --bg-gradient-start: #F8F9FA;
  --bg-gradient-end: #E0F2F7;
  --text-primary: #000000;
  --text-secondary: #4A5568;
  --text-muted: #707275;
  --border-color: #E5E7EB;
  --border-light: #D1D5DB;

  --primary: #F7931A;
  --primary-gradient-start: #F7931A;
  --primary-gradient-end: #FFB84D;
  --primary-dark: #E68517;
  --primary-light: #FFE5CC;
  --primary-hover: #E68517;

  --secondary: #ffffff;
  --secondary-border: #D1D5DB;
  --secondary-text: #333333;

  --accent: #7e3af2;
  --warning: #ff5a1f;
  --warning-bg: rgba(255, 90, 31, 0.1);
  --warning-border: #ff5a1f;
  --success: #0e9f6e;

  --card-bg: #ffffff;
  --card-border: #E5E7EB;
  --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);

  --mnemonic-bg: #f0f4f8;
  --mnemonic-word-bg: #FFE5CC;
  --mnemonic-word-text: #B85C0D;
  --mnemonic-word-border: rgba(247, 147, 26, 0.2);
  --mnemonic-word-hover-bg: #FFD9B3;
  --mnemonic-word-hover-text: #9A4A0A;

  --radius: 0.5rem;
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

[data-theme="dark"] {
  /* å¤œæ™šæ¨¡å¼ */
  --bg-primary: #0a0a0a;
  --bg-secondary: #1a202c;
  --bg-gradient-start: #0a0a0a;
  --bg-gradient-end: #1e293b;
  --text-primary: #ffffff;
  --text-secondary: #e2e8f0;
  --text-muted: #cbd5e0;
  --border-color: #4a5568;
  --border-light: #718096;

  --primary: #F7931A;
  --primary-gradient-start: #F7931A;
  --primary-gradient-end: #FFB84D;
  --primary-dark: #E68517;
  --primary-light: #8B5A2E;
  --primary-hover: #FFB84D;

  --secondary: #2d3748;
  --secondary-border: #4a5568;
  --secondary-text: #e2e8f0;

  --accent: #9f7aea;
  --warning: #ff7a47;
  --warning-bg: rgba(255, 90, 31, 0.2);
  --warning-border: #ff5a1f;
  --success: #48bb78;

  --card-bg: #1a202c;
  --card-border: #4a5568;
  --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);

  --mnemonic-bg: #1a202c;
  --mnemonic-word-bg: #8B5A2E;
  --mnemonic-word-text: #FFE5CC;
  --mnemonic-word-border: rgba(247, 147, 26, 0.4);
  --mnemonic-word-hover-bg: #E68517;
  --mnemonic-word-hover-text: #FFE5CC;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* å®‰å…¨å¢å¼ºï¼šä½¿ç”¨ç³»ç»Ÿå­—ä½“æ ˆï¼Œé¿å…å¤–éƒ¨å­—ä½“ä¾èµ– */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: linear-gradient(to bottom, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
  background-attachment: fixed;
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

body.loaded {
  opacity: 1;
  transform: translateY(0);
}

/* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--secondary);
  border: 1px solid var(--secondary-border);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.theme-toggle:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow-lg);
}

.theme-toggle svg {
  width: 24px;
  height: 24px;
  color: var(--text-primary);
}

/* å®¹å™¨å’Œå¸ƒå±€ */
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

header {
  text-align: center;
  margin-bottom: 30px;
}

header h1 {
  color: var(--text-primary);
  margin-bottom: 10px;
  font-size: 2.5rem;
  font-weight: 700;
}

header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
}

/* å®‰å…¨ç‰¹æ€§é¢æ¿ */
.security-features {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px;
  border-radius: var(--radius);
  margin-bottom: 20px;
  box-shadow: var(--shadow-md);
}

.security-features h3 {
  margin-bottom: 10px;
}

.security-features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  font-size: 0.9em;
}

/* è­¦å‘Šæ¡† */
.warning {
  background: var(--warning-bg);
  border: 1px solid var(--warning-border);
  border-radius: var(--radius);
  padding: 15px;
  margin-bottom: 20px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.warning-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.warning-content strong {
  color: var(--warning);
  display: block;
  margin-bottom: 5px;
}

.warning-text {
  color: var(--text-secondary);
  line-height: 1.5;
}

/* æ–‡ä»¶è¾“å…¥ */
.file-input {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 15px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.file-input label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--text-primary);
}

.file-input input[type="file"] {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  background: var(--secondary);
  color: var(--text-primary);
}

#sha256-display {
  margin-top: 10px;
  font-family: monospace;
  font-size: 0.9em;
  color: var(--text-muted);
  word-break: break-all;
}

/* é€‰é¡¹æŒ‰é’® */
.options {
  text-align: center;
  margin-bottom: 20px;
}

.options label {
  margin-right: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ä¸»è¦æŒ‰é’® */
.btn {
  background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: var(--radius);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-width: 200px;
}

.btn:hover {
  background: linear-gradient(135deg, var(--primary-hover), var(--primary-dark));
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background: var(--secondary);
  color: var(--secondary-text);
  border: 1px solid var(--secondary-border);
}

.btn-secondary:hover {
  background: var(--bg-secondary);
}

/* æŒ‰é’®ç»„ */
.controls {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

/* åŠ©è®°è¯æ˜¾ç¤ºåŒºåŸŸ */
.mnemonic {
  background: var(--mnemonic-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 30px;
  margin-bottom: 20px;
  min-height: 120px;
  word-wrap: break-word;
  position: relative;
  overflow: hidden;
}

.mnemonic.generating {
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-style: italic;
}

.mnemonic.generating::after {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid var(--text-muted);
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-left: 10px;
}

.mnemonic.cleared {
  animation: fadeOut 0.5s ease;
}

.mnemonic span {
  display: inline-block;
  background: var(--mnemonic-word-bg);
  color: var(--mnemonic-word-text);
  padding: 8px 12px;
  margin: 4px;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.2s ease;
  border: 1px solid var(--mnemonic-word-border);
}

.mnemonic span:hover {
  background: var(--mnemonic-word-hover-bg);
  color: var(--mnemonic-word-hover-text);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

/* åœ°å€æ˜¾ç¤ºåŒºåŸŸ */
.address-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.address-label {
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--text-primary);
}

.address-container {
  display: flex;
  gap: 10px;
  align-items: center;
}

.address-input {
  flex: 1;
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  font-family: monospace;
  font-size: 0.95em;
  background: var(--secondary);
  color: var(--text-primary);
  min-height: 44px;
}

.btn-copy-address {
  background: var(--primary);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
  min-height: 44px;
}

.btn-copy-address:hover {
  background: var(--primary-hover);
}

/* é¡µè„š */
footer {
  text-align: center;
  padding: 30px 20px;
  color: var(--text-muted);
  font-size: 0.9em;
  line-height: 1.6;
}

footer a {
  color: var(--primary);
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}

/* åŠ¨ç”» */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeOut {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .container {
    padding: 15px;
  }

  header h1 {
    font-size: 2rem;
  }

  .controls {
    flex-direction: column;
    align-items: center;
  }

  .btn {
    width: 100%;
    max-width: 300px;
  }

  .address-container {
    flex-direction: column;
  }

  .btn-copy-address {
    width: 100%;
  }

  .security-features-grid {
    grid-template-columns: 1fr;
  }
}

/* æ³¢çº¹æ•ˆæœ */
.ripple {
  position: absolute;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.6);
  transform: scale(0);
  animation: ripple-animation 0.6s ease-out;
  pointer-events: none;
}

@keyframes ripple-animation {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* åŠ è½½çŠ¶æ€ */
.btn.loading {
  pointer-events: none;
  opacity: 0.8;
}
</style>
</head>
<body>
<!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
<button class="theme-toggle" id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
  <svg id="sun-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
  <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
</button>

<div class="container">
  <header>
    <h1>æ¯”ç‰¹å¸åŠ©è®°è¯ç”Ÿæˆ</h1>
    <p>å®Œå…¨ç¦»çº¿ Â· å¼ºçƒˆå»ºè®®æ–­ç½‘ä½¿ç”¨ Â· å®‰å…¨å¢å¼ºç‰ˆ</p>
  </header>

  <!-- å®‰å…¨ç‰¹æ€§æ˜¾ç¤º -->
  <div class="security-features">
    <h3>ğŸ”’ å®‰å…¨ç‰¹æ€§</h3>
    <div class="security-features-grid">
      <div>âœ… å®Œå…¨ç¦»çº¿è¿è¡Œ</div>
      <div>âœ… é›¶å¤–éƒ¨ä¾èµ–</div>
      <div>âœ… å†…å­˜å®‰å…¨æ¸…ç†</div>
      <div>âœ… æ ‡å‡†ç®—æ³•å®ç°</div>
      <div>âœ… è‡ªæ£€éªŒè¯æœºåˆ¶</div>
      <div>âœ… ç³»ç»Ÿå­—ä½“ä½¿ç”¨</div>
    </div>
  </div>

  <main>
    <div class="warning">
      <div class="warning-icon">âš ï¸</div>
      <div class="warning-content">
        <strong>å®‰å…¨æç¤º</strong>
        <div class="warning-text">è¯·åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨æœ¬é¡µé¢ã€‚å†…ç½® BIP39 æ ‡å‡†è‹±æ–‡è¯è¡¨ï¼ˆ2048 è¯ï¼‰ï¼Œæ˜¾ç¤º SHA256 æ ¡éªŒå€¼ã€‚</div>
      </div>
    </div>

    <div class="options">
      <label>åŠ©è®°è¯é•¿åº¦ï¼š</label>
      <button id="btn-12" class="btn btn-secondary">12 è¯</button>
      <button id="btn-24" class="btn btn-secondary">24 è¯</button>
    </div>

    <div class="controls">
      <button id="btn-generate" class="btn">ğŸ² ç”ŸæˆåŠ©è®°è¯</button>
      <button id="btn-clear" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
    </div>

    <div class="mnemonic" id="mnemonic"></div>

    <div class="address-section" id="address-section" style="display: none;">
      <div class="address-label">æ¯”ç‰¹å¸æ”¶æ¬¾åœ°å€ (P2WPKH)ï¼š</div>
      <div class="address-container">
        <input type="text" id="btc-address" class="address-input" readonly placeholder="ç”ŸæˆåŠ©è®°è¯åè‡ªåŠ¨è®¡ç®—åœ°å€">
        <button id="btn-copy-address" class="btn-copy-address">å¤åˆ¶åœ°å€</button>
      </div>
    </div>
  </main>

  <footer>
    æºç å¼€æº Â· è¯·è‡ªè¡ŒéªŒè¯æœ¬é¡¹ç›® <br>
    éƒ¨ç½² &amp; å®‰å…¨ç”±ä½ æŒæ§ Â· å¼ºçƒˆå»ºè®®ä¿å­˜åŠ©è®°è¯åæ–­ç½‘å…³é—­æœ¬é¡µé¢ <br>
    å®Œæ•´ä¿®å¤ç‰ˆ Â· åŒ…å«æ‰€æœ‰ç®—æ³•å®ç°
  </footer>
</div>

<script>
// ========== å®‰å…¨å†…å­˜æ¸…ç† ==========

// å®‰å…¨æ¸…é›¶æ•æ„Ÿæ•°æ®
function secureWipe(data) {
  if (!data) return;

  if (data instanceof Uint8Array || data instanceof Array) {
    // æ¸…é›¶æ•°ç»„å†…å®¹
    for (let i = 0; i < data.length; i++) {
      data[i] = 0;
    }
  } else if (typeof data === 'string') {
    // å­—ç¬¦ä¸²æ— æ³•ç›´æ¥ä¿®æ”¹ï¼Œä½†å¯ä»¥è¦†ç›–å¼•ç”¨
    // è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ä¾›è°ƒç”¨è€…é‡æ–°èµ‹å€¼
    return '';
  } else if (typeof data === 'object') {
    // æ¸…é›¶å¯¹è±¡çš„æ‰€æœ‰å±æ€§
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        if (data[key] instanceof Uint8Array || data[key] instanceof Array) {
          secureWipe(data[key]);
        } else {
          data[key] = null;
        }
      }
    }
  }
}

// æ¸…ç†å¤šä¸ªæ•æ„Ÿå˜é‡
function secureWipeAll(...items) {
  for (const item of items) {
    secureWipe(item);
  }
}

// ========== å®Œæ•´çš„åŠ å¯†ç®—æ³•å®ç° ==========

// åŠ å¯†å·¥å…·
const cryptoObj = (typeof globalThis !== 'undefined' && globalThis.crypto) ? globalThis.crypto : null;
const hasSubtleCrypto = !!(cryptoObj && (typeof cryptoObj.subtle === 'object' || typeof cryptoObj.subtle === 'function'));

function ensureUint8Array(data) {
  if (data instanceof Uint8Array) return data;
  if (ArrayBuffer.isView(data)) {
    return new Uint8Array(data.buffer, data.byteOffset, data.byteLength);
  }
  if (data instanceof ArrayBuffer) {
    return new Uint8Array(data);
  }
  throw new TypeError('é¢„æœŸä¸º Uint8Array æˆ– ArrayBuffer');
}

function bytesToHex(bytes) {
  return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
}

function concatBytes(...arrays) {
  const length = arrays.reduce((sum, arr) => sum + arr.length, 0);
  const result = new Uint8Array(length);
  let offset = 0;
  for (const arr of arrays) {
    result.set(arr, offset);
    offset += arr.length;
  }
  return result;
}

function stringToBytes(str) {
  const encoder = new TextEncoder();
  return encoder.encode(str);
}

// SHA-256 å®ç°
const SHA256_IV_FALLBACK = new Uint32Array([
  0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a,
  0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19
]);

const SHA256_K_FALLBACK = new Uint32Array([
  0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
  0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
  0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
  0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
  0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
  0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
  0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
  0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
]);

function rotr32(x, n) {
  return (x >>> n) | (x << (32 - n));
}

function sha256Fallback(data) {
  const bytes = ensureUint8Array(data);
  const byteLength = bytes.length;
  const bitLength = byteLength * 8;
  const paddedLength = ((byteLength + 9 + 63) >>> 6) << 6;
  const padded = new Uint8Array(paddedLength);
  padded.set(bytes);
  padded[byteLength] = 0x80;

  const view = new DataView(padded.buffer);
  view.setUint32(paddedLength - 8, Math.floor(bitLength / 0x100000000), false);
  view.setUint32(paddedLength - 4, bitLength >>> 0, false);

  const w = new Uint32Array(64);
  let [a, b, c, d, e, f, g, h] = SHA256_IV_FALLBACK;

  for (let offset = 0; offset < paddedLength; offset += 64) {
    for (let i = 0; i < 16; i++) {
      w[i] = view.getUint32(offset + i * 4, false);
    }
    for (let i = 16; i < 64; i++) {
      const s0 = rotr32(w[i - 15], 7) ^ rotr32(w[i - 15], 18) ^ (w[i - 15] >>> 3);
      const s1 = rotr32(w[i - 2], 17) ^ rotr32(w[i - 2], 19) ^ (w[i - 2] >>> 10);
      w[i] = (w[i - 16] + s0 + w[i - 7] + s1) >>> 0;
    }

    let A = a, B = b, C = c, D = d, E = e, F = f, G = g, H = h;
    for (let i = 0; i < 64; i++) {
      const S1 = rotr32(E, 6) ^ rotr32(E, 11) ^ rotr32(E, 25);
      const ch = (E & F) ^ (~E & G);
      const temp1 = (H + S1 + ch + SHA256_K_FALLBACK[i] + w[i]) >>> 0;
      const S0 = rotr32(A, 2) ^ rotr32(A, 13) ^ rotr32(A, 22);
      const maj = (A & B) ^ (A & C) ^ (B & C);
      const temp2 = (S0 + maj) >>> 0;

      H = G;
      G = F;
      F = E;
      E = (D + temp1) >>> 0;
      D = C;
      C = B;
      B = A;
      A = (temp1 + temp2) >>> 0;
    }

    a = (a + A) >>> 0;
    b = (b + B) >>> 0;
    c = (c + C) >>> 0;
    d = (d + D) >>> 0;
    e = (e + E) >>> 0;
    f = (f + F) >>> 0;
    g = (g + G) >>> 0;
    h = (h + H) >>> 0;
  }

  const result = new Uint8Array(32);
  const words = [a, b, c, d, e, f, g, h];
  for (let i = 0; i < words.length; i++) {
    result[i * 4] = (words[i] >>> 24) & 0xff;
    result[i * 4 + 1] = (words[i] >>> 16) & 0xff;
    result[i * 4 + 2] = (words[i] >>> 8) & 0xff;
    result[i * 4 + 3] = words[i] & 0xff;
  }
  return result;
}

async function sha256Bytes(data) {
  if (hasSubtleCrypto && cryptoObj?.subtle) {
    const digest = await cryptoObj.subtle.digest('SHA-256', ensureUint8Array(data));
    return new Uint8Array(digest);
  }
  return sha256Fallback(data);
}

// HMAC-SHA512
function hmacSha512Fallback(key, data) {
  const blockSize = 128;
  let keyBytes = ensureUint8Array(key);
  if (keyBytes.length > blockSize) {
    keyBytes = sha512Fallback(keyBytes);
  }
  const oKeyPad = new Uint8Array(blockSize);
  const iKeyPad = new Uint8Array(blockSize);
  for (let i = 0; i < blockSize; i++) {
    const keyByte = i < keyBytes.length ? keyBytes[i] : 0;
    iKeyPad[i] = keyByte ^ 0x36;
    oKeyPad[i] = keyByte ^ 0x5c;
  }
  const inner = sha512Fallback(concatBytes(iKeyPad, ensureUint8Array(data)));
  return sha512Fallback(concatBytes(oKeyPad, inner));
}

// SHA-512 å®Œæ•´å®ç°
const SHA512_IV = [
  0x6a09e667, 0xf3bcc908, 0xbb67ae85, 0x84caa73b,
  0x3c6ef372, 0xfe94f82b, 0xa54ff53a, 0x5f1d36f1,
  0x510e527f, 0xade682d1, 0x9b05688c, 0x2b3e6c1f,
  0x1f83d9ab, 0xfb41bd6b, 0x5be0cd19, 0x137e2179
];

const SHA512_K = [
  0x428a2f98, 0xd728ae22, 0x71374491, 0x23ef65cd, 0xb5c0fbcf, 0xec4d3b2f, 0xe9b5dba5, 0x8189dbbc,
  0x3956c25b, 0xf348b538, 0x59f111f1, 0xb605d019, 0x923f82a4, 0xaf194f9b, 0xab1c5ed5, 0xda6d8118,
  0xd807aa98, 0xa3030242, 0x12835b01, 0x45706fbe, 0x243185be, 0x4ee4b28c, 0x550c7dc3, 0xd5ffb4e2,
  0x72be5d74, 0xf27b896f, 0x80deb1fe, 0x3b1696b1, 0x9bdc06a7, 0x25c71235, 0xc19bf174, 0xcf692694,
  0xe49b69c1, 0x9ef14ad2, 0xefbe4786, 0x384f25e3, 0x0fc19dc6, 0x8b8cd5b5, 0x240ca1cc, 0x77ac9c65,
  0x2de92c6f, 0x592b0275, 0x4a7484aa, 0x6ea6e483, 0x5cb0a9dc, 0xbd41fbd4, 0x76f988da, 0x831153b5,
  0x983e5152, 0xee66dfab, 0xa831c66d, 0x2db43210, 0xb00327c8, 0x98fb213f, 0xbf597fc7, 0xbeef0ee4,
  0xc6e00bf3, 0x3da88fc2, 0xd5a79147, 0x930aa725, 0x06ca6351, 0xe003826f, 0x14292967, 0x0a0e6e70,
  0x27b70a85, 0x46d22ffc, 0x2e1b2138, 0x5c26c926, 0x4d2c6dfc, 0x5ac42aed, 0x53380d13, 0x9d95b3df,
  0x650a7354, 0x8baf63de, 0x766a0abb, 0x3c77b2a8, 0x81c2c92e, 0x47edaee6, 0x92722c85, 0x1482353b,
  0xa2bfe8a1, 0x4cf10364, 0xa81a664b, 0xbc423001, 0xc24b8b70, 0xd0f89791, 0xc76c51a3, 0x0654be30,
  0xd192e819, 0xd6ef5218, 0xd6990624, 0x5565a910, 0xf40e3585, 0x5771202a, 0x106aa070, 0x32bbd1b8,
  0x19a4c116, 0xb8d2d0c8, 0x1e376c08, 0x5141ab53, 0x2748774c, 0xdf8eeb99, 0x34b0bcb5, 0xe19b48a8,
  0x391c0cb3, 0xc5c95a63, 0x4ed8aa4a, 0xe3418acb, 0x5b9cca4f, 0x7763e373, 0x682e6ff3, 0xd6b2b8a3,
  0x748f82ee, 0x5defb2fc, 0x78a5636f, 0x43172f60, 0x84c87814, 0xa1f0ab72, 0x8cc70208, 0x1a6439ec,
  0x90befffa, 0x23631e28, 0xa4506ceb, 0xde82bde9, 0xbef9a3f7, 0xb2c67915, 0xc67178f2, 0xe372532b,
  0xca273ece, 0xea26619c, 0xd186b8c7, 0x21c0c207, 0xeada7dd6, 0xcde0eb1e, 0xf57d4f7f, 0xee6ed178,
  0x06f067aa, 0x72176fba, 0x0a637dc5, 0xa2c898a6, 0x113f9804, 0xbef90dae, 0x1b710b35, 0x131c471b,
  0x28db77f5, 0x23047d84, 0x32caab7b, 0x40c72493, 0x3c9ebe0a, 0x15c9bebc, 0x431d67c4, 0x9c100d4c,
  0x4cc5d4be, 0xcb3e42b6, 0x597f299c, 0xfc657e2a, 0x5fcb6fab, 0x3ad6faec, 0x6c44198c, 0x4a475817
];

function rotr64_hi(ah, al, n) {
  if (n === 32) return al;
  if (n < 32) return (ah >>> n) | (al << (32 - n));
  n -= 32;
  return (al >>> n) | (ah << (32 - n));
}

function rotr64_lo(ah, al, n) {
  if (n === 32) return ah;
  if (n < 32) return (al >>> n) | (ah << (32 - n));
  n -= 32;
  return (ah >>> n) | (al << (32 - n));
}

function shr64_hi(ah, al, n) {
  if (n === 32) return 0;
  if (n < 32) return ah >>> n;
  return 0;
}

function shr64_lo(ah, al, n) {
  if (n === 32) return ah;
  if (n < 32) return (al >>> n) | (ah << (32 - n));
  n -= 32;
  return ah >>> n;
}

function sha512Fallback(data) {
  const bytes = ensureUint8Array(data);
  const byteLength = bytes.length;
  const bitLength = byteLength * 8;
  const paddedLength = ((byteLength + 17 + 127) >>> 7) << 7;
  const padded = new Uint8Array(paddedLength);
  padded.set(bytes);
  padded[byteLength] = 0x80;

  const view = new DataView(padded.buffer);
  view.setUint32(paddedLength - 8, Math.floor(bitLength / 0x100000000), false);
  view.setUint32(paddedLength - 4, bitLength >>> 0, false);

  const w = new Uint32Array(160);
  let h = SHA512_IV.slice();

  for (let offset = 0; offset < paddedLength; offset += 128) {
    for (let i = 0; i < 16; i++) {
      w[i * 2] = view.getUint32(offset + i * 8, false);
      w[i * 2 + 1] = view.getUint32(offset + i * 8 + 4, false);
    }

    for (let i = 16; i < 80; i++) {
      const w15h = w[(i - 15) * 2];
      const w15l = w[(i - 15) * 2 + 1];
      const s0h = rotr64_hi(w15h, w15l, 1) ^ rotr64_hi(w15h, w15l, 8) ^ shr64_hi(w15h, w15l, 7);
      const s0l = rotr64_lo(w15h, w15l, 1) ^ rotr64_lo(w15h, w15l, 8) ^ shr64_lo(w15h, w15l, 7);

      const w2h = w[(i - 2) * 2];
      const w2l = w[(i - 2) * 2 + 1];
      const s1h = rotr64_hi(w2h, w2l, 19) ^ rotr64_hi(w2h, w2l, 61) ^ shr64_hi(w2h, w2l, 6);
      const s1l = rotr64_lo(w2h, w2l, 19) ^ rotr64_lo(w2h, w2l, 61) ^ shr64_lo(w2h, w2l, 6);

      const w7h = w[(i - 7) * 2];
      const w7l = w[(i - 7) * 2 + 1];
      const w16h = w[(i - 16) * 2];
      const w16l = w[(i - 16) * 2 + 1];

      let tempL = (w16l + s0l) >>> 0;
      let tempH = w16h + s0h + (tempL < w16l ? 1 : 0);
      tempL = (tempL + w7l) >>> 0;
      tempH = tempH + w7h + (tempL < w7l ? 1 : 0);
      tempL = (tempL + s1l) >>> 0;
      tempH = tempH + s1h + (tempL < s1l ? 1 : 0);

      w[i * 2] = tempH >>> 0;
      w[i * 2 + 1] = tempL >>> 0;
    }

    let [ah, al, bh, bl, ch, cl, dh, dl, eh, el, fh, fl, gh, gl, hh, hl] = h;

    for (let i = 0; i < 80; i++) {
      const S1h = rotr64_hi(eh, el, 14) ^ rotr64_hi(eh, el, 18) ^ rotr64_hi(eh, el, 41);
      const S1l = rotr64_lo(eh, el, 14) ^ rotr64_lo(eh, el, 18) ^ rotr64_lo(eh, el, 41);

      const chh = (eh & fh) ^ (~eh & gh);
      const chl = (el & fl) ^ (~el & gl);

      let temp1L = (hl + S1l) >>> 0;
      let temp1H = hh + S1h + (temp1L < hl ? 1 : 0);
      temp1L = (temp1L + chl) >>> 0;
      temp1H = temp1H + chh + (temp1L < chl ? 1 : 0);
      temp1L = (temp1L + SHA512_K[i * 2 + 1]) >>> 0;
      temp1H = temp1H + SHA512_K[i * 2] + (temp1L < SHA512_K[i * 2 + 1] ? 1 : 0);
      temp1L = (temp1L + w[i * 2 + 1]) >>> 0;
      temp1H = temp1H + w[i * 2] + (temp1L < w[i * 2 + 1] ? 1 : 0);

      const S0h = rotr64_hi(ah, al, 28) ^ rotr64_hi(ah, al, 34) ^ rotr64_hi(ah, al, 39);
      const S0l = rotr64_lo(ah, al, 28) ^ rotr64_lo(ah, al, 34) ^ rotr64_lo(ah, al, 39);

      const majh = (ah & bh) ^ (ah & ch) ^ (bh & ch);
      const majl = (al & bl) ^ (al & cl) ^ (bl & cl);

      let temp2L = (S0l + majl) >>> 0;
      let temp2H = S0h + majh + (temp2L < S0l ? 1 : 0);

      hh = gh; hl = gl;
      gh = fh; gl = fl;
      fh = eh; fl = el;
      el = (dl + temp1L) >>> 0;
      eh = dh + temp1H + (el < dl ? 1 : 0);
      dh = ch; dl = cl;
      ch = bh; cl = bl;
      bh = ah; bl = al;
      al = (temp1L + temp2L) >>> 0;
      ah = temp1H + temp2H + (al < temp1L ? 1 : 0);
    }

    al = (h[1] + al) >>> 0;
    ah = (h[0] + ah + (al < h[1] ? 1 : 0)) >>> 0;
    bl = (h[3] + bl) >>> 0;
    bh = (h[2] + bh + (bl < h[3] ? 1 : 0)) >>> 0;
    cl = (h[5] + cl) >>> 0;
    ch = (h[4] + ch + (cl < h[5] ? 1 : 0)) >>> 0;
    dl = (h[7] + dl) >>> 0;
    dh = (h[6] + dh + (dl < h[7] ? 1 : 0)) >>> 0;
    el = (h[9] + el) >>> 0;
    eh = (h[8] + eh + (el < h[9] ? 1 : 0)) >>> 0;
    fl = (h[11] + fl) >>> 0;
    fh = (h[10] + fh + (fl < h[11] ? 1 : 0)) >>> 0;
    gl = (h[13] + gl) >>> 0;
    gh = (h[12] + gh + (gl < h[13] ? 1 : 0)) >>> 0;
    hl = (h[15] + hl) >>> 0;
    hh = (h[14] + hh + (hl < h[15] ? 1 : 0)) >>> 0;

    h = [ah, al, bh, bl, ch, cl, dh, dl, eh, el, fh, fl, gh, gl, hh, hl];
  }

  const result = new Uint8Array(64);
  for (let i = 0; i < 8; i++) {
    const hi = h[i * 2];
    const lo = h[i * 2 + 1];
    result[i * 8] = (hi >>> 24) & 0xff;
    result[i * 8 + 1] = (hi >>> 16) & 0xff;
    result[i * 8 + 2] = (hi >>> 8) & 0xff;
    result[i * 8 + 3] = hi & 0xff;
    result[i * 8 + 4] = (lo >>> 24) & 0xff;
    result[i * 8 + 5] = (lo >>> 16) & 0xff;
    result[i * 8 + 6] = (lo >>> 8) & 0xff;
    result[i * 8 + 7] = lo & 0xff;
  }
  return result;
}

async function hmacSha512(key, data) {
  return hmacSha512Fallback(key, data);
}

// PBKDF2-HMAC-SHA512
function pbkdf2HmacSha512Fallback(password, salt, iterations, dkLen) {
  const passBytes = ensureUint8Array(password);
  const saltBytes = ensureUint8Array(salt);
  const hashLen = 64;
  const blockCount = Math.ceil(dkLen / hashLen);
  const dk = new Uint8Array(blockCount * hashLen);
  const block = new Uint8Array(saltBytes.length + 4);
  block.set(saltBytes, 0);

  for (let blockIndex = 1; blockIndex <= blockCount; blockIndex++) {
    block[saltBytes.length] = (blockIndex >>> 24) & 0xff;
    block[saltBytes.length + 1] = (blockIndex >>> 16) & 0xff;
    block[saltBytes.length + 2] = (blockIndex >>> 8) & 0xff;
    block[saltBytes.length + 3] = blockIndex & 0xff;

    let u = hmacSha512Fallback(passBytes, block);
    const t = new Uint8Array(u);

    for (let i = 1; i < iterations; i++) {
      u = hmacSha512Fallback(passBytes, u);
      for (let j = 0; j < hashLen; j++) {
        t[j] ^= u[j];
      }
    }

    dk.set(t, (blockIndex - 1) * hashLen);
  }

  return dk.slice(0, dkLen);
}

async function pbkdf2HmacSha512(password, salt, iterations, dkLen) {
  if (hasSubtleCrypto && cryptoObj?.subtle) {
    const keyMaterial = await cryptoObj.subtle.importKey(
      'raw', ensureUint8Array(password), { name: 'PBKDF2' }, false, ['deriveBits']
    );
    const bits = await cryptoObj.subtle.deriveBits(
      { name: 'PBKDF2', salt: ensureUint8Array(salt), iterations, hash: 'SHA-512' },
      keyMaterial,
      dkLen * 8
    );
    return new Uint8Array(bits);
  }
  return pbkdf2HmacSha512Fallback(password, salt, iterations, dkLen);
}

// BIP39 è¯è¡¨
const EMBEDDED_BIP39_WORDLIST = ['abandon','ability','able','about','above','absent','absorb','abstract','absurd','abuse','access','accident','account','accuse','achieve','acid','acoustic','acquire','across','act','action','actor','actress','actual','adapt','add','addict','address','adjust','admit','adult','advance','advice','aerobic','affair','afford','afraid','again','age','agent','agree','ahead','aim','air','airport','aisle','alarm','album','alcohol','alert','alien','all','alley','allow','almost','alone','alpha','already','also','alter','always','amateur','amazing','among','amount','amused','analyst','anchor','ancient','anger','angle','angry','animal','ankle','announce','annual','another','answer','antenna','antique','anxiety','any','apart','apology','appear','apple','approve','april','arch','arctic','area','arena','argue','arm','armed','armor','army','around','arrange','arrest','arrive','arrow','art','artefact','artist','artwork','ask','aspect','assault','asset','assist','assume','asthma','athlete','atom','attack','attend','attitude','attract','auction','audit','august','aunt','author','auto','autumn','average','avocado','avoid','awake','aware','away','awesome','awful','awkward','axis','baby','bachelor','bacon','badge','bag','balance','balcony','ball','bamboo','banana','banner','bar','barely','bargain','barrel','base','basic','basket','battle','beach','bean','beauty','because','become','beef','before','begin','behave','behind','believe','below','belt','bench','benefit','best','betray','better','between','beyond','bicycle','bid','bike','bind','biology','bird','birth','bitter','black','blade','blame','blanket','blast','bleak','bless','blind','blood','blossom','blouse','blue','blur','blush','board','boat','body','boil','bomb','bone','bonus','book','boost','border','boring','borrow','boss','bottom','bounce','box','boy','bracket','brain','brand','brass','brave','bread','breeze','brick','bridge','brief','bright','bring','brisk','broccoli','broken','bronze','broom','brother','brown','brush','bubble','buddy','budget','buffalo','build','bulb','bulk','bullet','bundle','bunker','burden','burger','burst','bus','business','busy','butter','buyer','buzz','cabbage','cabin','cable','cactus','cage','cake','call','calm','camera','camp','can','canal','cancel','candy','cannon','canoe','canvas','canyon','capable','capital','captain','car','carbon','card','cargo','carpet','carry','cart','case','cash','casino','castle','casual','cat','catalog','catch','category','cattle','caught','cause','caution','cave','ceiling','celery','cement','census','century','cereal','certain','chair','chalk','champion','change','chaos','chapter','charge','chase','chat','cheap','check','cheese','chef','cherry','chest','chicken','chief','child','chimney','choice','choose','chronic','chuckle','chunk','churn','cigar','cinnamon','circle','citizen','city','civil','claim','clap','clarify','claw','clay','clean','clerk','clever','click','client','cliff','climb','clinic','clip','clock','clog','close','cloth','cloud','clown','club','clump','cluster','clutch','coach','coast','coconut','code','coffee','coil','coin','collect','color','column','combine','come','comfort','comic','common','company','concert','conduct','confirm','congress','connect','consider','control','convince','cook','cool','copper','copy','coral','core','corn','correct','cost','cotton','couch','country','couple','course','cousin','cover','coyote','crack','cradle','craft','cram','crane','crash','crater','crawl','crazy','cream','credit','creek','crew','cricket','crime','crisp','critic','crop','cross','crouch','crowd','crucial','cruel','cruise','crumble','crunch','crush','cry','crystal','cube','culture','cup','cupboard','curious','current','curtain','curve','cushion','custom','cute','cycle','dad','damage','damp','dance','danger','daring','dash','daughter','dawn','day','deal','debate','debris','decade','december','decide','decline','decorate','decrease','deer','defense','define','defy','degree','delay','deliver','demand','demise','denial','dentist','deny','depart','depend','deposit','depth','deputy','derive','describe','desert','design','desk','despair','destroy','detail','detect','develop','device','devote','diagram','dial','diamond','diary','dice','diesel','diet','differ','digital','dignity','dilemma','dinner','dinosaur','direct','dirt','disagree','discover','disease','dish','dismiss','disorder','display','distance','divert','divide','divorce','dizzy','doctor','document','dog','doll','dolphin','domain','donate','donkey','donor','door','dose','double','dove','draft','dragon','drama','drastic','draw','dream','dress','drift','drill','drink','drip','drive','drop','drum','dry','duck','dumb','dune','during','dust','dutch','duty','dwarf','dynamic','eager','eagle','early','earn','earth','easily','east','easy','echo','ecology','economy','edge','edit','educate','effort','egg','eight','either','elbow','elder','electric','elegant','element','elephant','elevator','elite','else','embark','embody','embrace','emerge','emotion','employ','empower','empty','enable','enact','end','endless','endorse','enemy','energy','enforce','engage','engine','enhance','enjoy','enlist','enough','enrich','enroll','ensure','enter','entire','entry','envelope','episode','equal','equip','era','erase','erode','erosion','error','erupt','escape','essay','essence','estate','eternal','ethics','evidence','evil','evoke','evolve','exact','example','excess','exchange','excite','exclude','excuse','execute','exercise','exhaust','exhibit','exile','exist','exit','exotic','expand','expect','expire','explain','expose','express','extend','extra','eye','eyebrow','fabric','face','faculty','fade','faint','faith','fall','false','fame','family','famous','fan','fancy','fantasy','farm','fashion','fat','fatal','father','fatigue','fault','favorite','feature','february','federal','fee','feed','feel','female','fence','festival','fetch','fever','few','fiber','fiction','field','figure','file','film','filter','final','find','fine','finger','finish','fire','firm','first','fiscal','fish','fit','fitness','fix','flag','flame','flash','flat','flavor','flee','flight','flip','float','flock','floor','flower','fluid','flush','fly','foam','focus','fog','foil','fold','follow','food','foot','force','forest','forget','fork','fortune','forum','forward','fossil','foster','found','fox','fragile','frame','frequent','fresh','friend','fringe','frog','front','frost','frown','frozen','fruit','fuel','fun','funny','furnace','fury','future','gadget','gain','galaxy','gallery','game','gap','garage','garbage','garden','garlic','garment','gas','gasp','gate','gather','gauge','gaze','general','genius','genre','gentle','genuine','gesture','ghost','giant','gift','giggle','ginger','giraffe','girl','give','glad','glance','glare','glass','glide','glimpse','globe','gloom','glory','glove','glow','glue','goat','goddess','gold','good','goose','gorilla','gospel','gossip','govern','gown','grab','grace','grain','grant','grape','grass','gravity','great','green','grid','grief','grit','grocery','group','grow','grunt','guard','guess','guide','guilt','guitar','gun','gym','habit','hair','half','hammer','hamster','hand','happy','harbor','hard','harsh','harvest','hat','have','hawk','hazard','head','health','heart','heavy','hedgehog','height','hello','helmet','help','hen','hero','hidden','high','hill','hint','hip','hire','history','hobby','hockey','hold','hole','holiday','hollow','home','honey','hood','hope','horn','horror','horse','hospital','host','hotel','hour','hover','hub','huge','human','humble','humor','hundred','hungry','hunt','hurdle','hurry','hurt','husband','hybrid','ice','icon','idea','identify','idle','ignore','ill','illegal','illness','image','imitate','immense','immune','impact','impose','improve','impulse','inch','include','income','increase','index','indicate','indoor','industry','infant','inflict','inform','inhale','inherit','initial','inject','injury','inmate','inner','innocent','input','inquiry','insane','insect','inside','inspire','install','intact','interest','into','invest','invite','involve','iron','island','isolate','issue','item','ivory','jacket','jaguar','jar','jazz','jealous','jeans','jelly','jewel','job','join','joke','journey','joy','judge','juice','jump','jungle','junior','junk','just','kangaroo','keen','keep','ketchup','key','kick','kid','kidney','kind','kingdom','kiss','kit','kitchen','kite','kitten','kiwi','knee','knife','knock','know','lab','label','labor','ladder','lady','lake','lamp','language','laptop','large','later','latin','laugh','laundry','lava','law','lawn','lawsuit','layer','lazy','leader','leaf','learn','leave','lecture','left','leg','legal','legend','leisure','lemon','lend','length','lens','leopard','lesson','letter','level','liar','liberty','library','license','life','lift','light','like','limb','limit','link','lion','liquid','list','little','live','lizard','load','loan','lobster','local','lock','logic','lonely','long','loop','lottery','loud','lounge','love','loyal','lucky','luggage','lumber','lunar','lunch','luxury','lyrics','machine','mad','magic','magnet','maid','mail','main','major','make','mammal','man','manage','mandate','mango','mansion','manual','maple','marble','march','margin','marine','market','marriage','mask','mass','master','match','material','math','matrix','matter','maximum','maze','meadow','mean','measure','meat','mechanic','medal','media','melody','melt','member','memory','mention','menu','mercy','merge','merit','merry','mesh','message','metal','method','middle','midnight','milk','million','mimic','mind','minimum','minor','minute','miracle','mirror','misery','miss','mistake','mix','mixed','mixture','mobile','model','modify','mom','moment','monitor','monkey','monster','month','moon','moral','more','morning','mosquito','mother','motion','motor','mountain','mouse','move','movie','much','muffin','mule','multiply','muscle','museum','mushroom','music','must','mutual','myself','mystery','myth','naive','name','napkin','narrow','nasty','nation','nature','near','neck','need','negative','neglect','neither','nephew','nerve','nest','net','network','neutral','never','news','next','nice','night','noble','noise','nominee','noodle','normal','north','nose','notable','note','nothing','notice','novel','now','nuclear','number','nurse','nut','oak','obey','object','oblige','obscure','observe','obtain','obvious','occur','ocean','october','odor','off','offer','office','often','oil','okay','old','olive','olympic','omit','once','one','onion','online','only','open','opera','opinion','oppose','option','orange','orbit','orchard','order','ordinary','organ','orient','original','orphan','ostrich','other','outdoor','outer','output','outside','oval','oven','over','own','owner','oxygen','oyster','ozone','pact','paddle','page','pair','palace','palm','panda','panel','panic','panther','paper','parade','parent','park','parrot','party','pass','patch','path','patient','patrol','pattern','pause','pave','payment','peace','peanut','pear','peasant','pelican','pen','penalty','pencil','people','pepper','perfect','permit','person','pet','phone','photo','phrase','physical','piano','picnic','picture','piece','pig','pigeon','pill','pilot','pink','pioneer','pipe','pistol','pitch','pizza','place','planet','plastic','plate','play','please','pledge','pluck','plug','plunge','poem','poet','point','polar','pole','police','pond','pony','pool','popular','portion','position','possible','post','potato','pottery','poverty','powder','power','practice','praise','predict','prefer','prepare','present','pretty','prevent','price','pride','primary','print','priority','prison','private','prize','problem','process','produce','profit','program','project','promote','proof','property','prosper','protect','proud','provide','public','pudding','pull','pulp','pulse','pumpkin','punch','pupil','puppy','purchase','purity','purpose','purse','push','put','puzzle','pyramid','quality','quantum','quarter','question','quick','quit','quiz','quote','rabbit','raccoon','race','rack','radar','radio','rail','rain','raise','rally','ramp','ranch','random','range','rapid','rare','rate','rather','raven','raw','razor','ready','real','reason','rebel','rebuild','recall','receive','recipe','record','recycle','reduce','reflect','reform','refuse','region','regret','regular','reject','relax','release','relief','rely','remain','remember','remind','remove','render','renew','rent','reopen','repair','repeat','replace','report','require','rescue','resemble','resist','resource','response','result','retire','retreat','return','reunion','reveal','review','reward','rhythm','rib','ribbon','rice','rich','ride','ridge','rifle','right','rigid','ring','riot','ripple','risk','ritual','rival','river','road','roast','robot','robust','rocket','romance','roof','rookie','room','rose','rotate','rough','round','route','royal','rubber','rude','rug','rule','run','runway','rural','sad','saddle','sadness','safe','sail','salad','salmon','salon','salt','salute','same','sample','sand','satisfy','satoshi','sauce','sausage','save','say','scale','scan','scare','scatter','scene','scheme','school','science','scissors','scorpion','scout','scrap','screen','script','scrub','sea','search','season','seat','second','secret','section','security','seed','seek','segment','select','sell','seminar','senior','sense','sentence','series','service','session','settle','setup','seven','shadow','shaft','shallow','share','shed','shell','sheriff','shield','shift','shine','ship','shiver','shock','shoe','shoot','shop','short','shoulder','shove','shrimp','shrug','shuffle','shy','sibling','sick','side','siege','sight','sign','silent','silk','silly','silver','similar','simple','since','sing','siren','sister','situate','six','size','skate','sketch','ski','skill','skin','skirt','skull','slab','slam','sleep','slender','slice','slide','slight','slim','slogan','slot','slow','slush','small','smart','smile','smoke','smooth','snack','snake','snap','sniff','snow','soap','soccer','social','sock','soda','soft','solar','soldier','solid','solution','solve','someone','song','soon','sorry','sort','soul','sound','soup','source','south','space','spare','spatial','spawn','speak','special','speed','spell','spend','sphere','spice','spider','spike','spin','spirit','split','spoil','sponsor','spoon','sport','spot','spray','spread','spring','spy','square','squeeze','squirrel','stable','stadium','staff','stage','stairs','stamp','stand','start','state','stay','steak','steel','stem','step','stereo','stick','still','sting','stock','stomach','stone','stool','story','stove','strategy','street','strike','strong','struggle','student','stuff','stumble','style','subject','submit','subway','success','such','sudden','suffer','sugar','suggest','suit','summer','sun','sunny','sunset','super','supply','supreme','sure','surface','surge','surprise','surround','survey','suspect','sustain','swallow','swamp','swap','swarm','swear','sweet','swift','swim','swing','switch','sword','symbol','symptom','syrup','system','table','tackle','tag','tail','talent','talk','tank','tape','target','task','taste','tattoo','taxi','teach','team','tell','ten','tenant','tennis','tent','term','test','text','thank','that','theme','then','theory','there','they','thing','this','thought','three','thrive','throw','thumb','thunder','ticket','tide','tiger','tilt','timber','time','tiny','tip','tired','tissue','title','toast','tobacco','today','toddler','toe','together','toilet','token','tomato','tomorrow','tone','tongue','tonight','tool','tooth','top','topic','topple','torch','tornado','tortoise','toss','total','tourist','toward','tower','town','toy','track','trade','traffic','tragic','train','transfer','trap','trash','travel','tray','treat','tree','trend','trial','tribe','trick','trigger','trim','trip','trophy','trouble','truck','true','truly','trumpet','trust','truth','try','tube','tuition','tumble','tuna','tunnel','turkey','turn','turtle','twelve','twenty','twice','twin','twist','two','type','typical','ugly','umbrella','unable','unaware','uncle','uncover','under','undo','unfair','unfold','unhappy','uniform','unique','unit','universe','unknown','unlock','until','unusual','unveil','update','upgrade','uphold','upon','upper','upset','urban','urge','usage','use','used','useful','useless','usual','utility','vacant','vacuum','vague','valid','valley','valve','van','vanish','vapor','various','vast','vault','vehicle','velvet','vendor','venture','venue','verb','verify','version','very','vessel','veteran','viable','vibrant','vicious','victory','video','view','village','vintage','violin','virtual','virus','visa','visit','visual','vital','vivid','vocal','voice','void','volcano','volume','vote','voyage','wage','wagon','wait','walk','wall','walnut','want','warfare','warm','warrior','wash','wasp','waste','water','wave','way','wealth','weapon','wear','weasel','weather','web','wedding','weekend','weird','welcome','west','wet','whale','what','wheat','wheel','when','where','whip','whisper','wide','width','wife','wild','will','win','window','wine','wing','wink','winner','winter','wire','wisdom','wise','wish','witness','wolf','woman','wonder','wood','wool','word','work','world','worry','worth','wrap','wreck','wrestle','wrist','write','wrong','yard','year','yellow','you','young','youth','zebra','zero','zone','zoo'];

// ========== ä¸»è¦åŠŸèƒ½å®ç° ==========

// DOMå…ƒç´ è·å–
const btnGenerate = document.getElementById("btn-generate");
const mnemonicDiv = document.getElementById("mnemonic");
const btnClear = document.getElementById("btn-clear");
const btn12 = document.getElementById("btn-12");
const btn24 = document.getElementById("btn-24");
const addressSection = document.getElementById("address-section");
const btcAddressInput = document.getElementById("btc-address");
const btnCopyAddress = document.getElementById("btn-copy-address");

let wordCount = 12;
btn12.disabled = true;

// æ·»åŠ æŒ‰é’®ç‚¹å‡»æ³¢çº¹æ•ˆæœ
const addRippleEffect = (button) => {
  button.addEventListener('click', function(e) {
    if (this.disabled) return;

    const ripple = document.createElement('span');
    ripple.classList.add('ripple');
    this.appendChild(ripple);

    const rect = this.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);

    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
    ripple.style.top = `${e.clientY - rect.top - size/2}px`;

    ripple.classList.add('active');

    setTimeout(() => {
      ripple.remove();
    }, 600);
  });
};

// ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ æ³¢çº¹æ•ˆæœ
document.querySelectorAll('button').forEach(addRippleEffect);

// æ·»åŠ åŠ è½½åŠ¨ç”»
function showLoading(element) {
  element.classList.add('loading');
  element.setAttribute('data-text', element.textContent);
  element.textContent = 'å¤„ç†ä¸­...';
}

function hideLoading(element) {
  if (element.classList.contains('loading')) {
    element.textContent = element.getAttribute('data-text');
    element.classList.remove('loading');
  }
}

// è¯æ•°é€‰æ‹©
btn12.addEventListener("click", () => {
  wordCount = 12;
  btn12.disabled = true;
  btn24.disabled = false;
});

btn24.addEventListener("click", () => {
  wordCount = 24;
  btn12.disabled = false;
  btn24.disabled = true;
});

// ç”Ÿæˆå®‰å…¨çš„éšæœºç†µ
function generateEntropy(bytes) {
  if (bytes !== 16 && bytes !== 32) {
    throw new Error('ç†µé•¿åº¦å¿…é¡»æ˜¯16å­—èŠ‚ï¼ˆ12è¯ï¼‰æˆ–32å­—èŠ‚ï¼ˆ24è¯ï¼‰');
  }

  const arr = new Uint8Array(bytes);
  if (!cryptoObj || typeof cryptoObj.getRandomValues !== 'function') {
    throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒå®‰å…¨éšæœºæ•°ç”Ÿæˆ');
  }
  cryptoObj.getRandomValues(arr);

  return arr;
}

// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºä½æ•°ç»„
function bytesToBits(bytes) {
  const bits = [];
  for (let b of bytes) {
    for (let i = 7; i >= 0; i--) {
      bits.push((b >> i) & 1);
    }
  }
  return bits;
}

// å°†ä½æ•°ç»„è½¬æ¢ä¸ºæ•´æ•°
function bitsToInt(bits) {
  return bits.reduce((acc, b) => (acc << 1) | b, 0);
}

// BIP39: ä»ç†µç”ŸæˆåŠ©è®°è¯
async function entropyToMnemonic(entropy, wordlist) {
  if (!entropy || entropy.length === 0) {
    throw new Error('ç†µä¸èƒ½ä¸ºç©º');
  }
  if (!wordlist || wordlist.length !== 2048) {
    throw new Error('è¯è¡¨å¿…é¡»åŒ…å«2048ä¸ªå•è¯');
  }

  const ENT = entropy.length * 8;
  const checksumLen = ENT / 32;

  const hash = await sha256Bytes(entropy);

  const entropyBits = bytesToBits(entropy);
  const checksumBits = bytesToBits(hash).slice(0, checksumLen);
  const allBits = entropyBits.concat(checksumBits);

  const expectedBits = Math.floor((ENT + checksumLen) / 11) * 11;
  if (allBits.length !== expectedBits) {
    throw new Error(`ä½æ•°ç»„é•¿åº¦ä¸æ­£ç¡®: ${allBits.length}, æœŸæœ›: ${expectedBits}`);
  }

  const chunks = [];
  const wordCount = allBits.length / 11;

  for (let i = 0; i < wordCount; i++) {
    const start = i * 11;
    const end = start + 11;
    const wordIndex = bitsToInt(allBits.slice(start, end));

    if (wordIndex < 0 || wordIndex >= 2048) {
      throw new Error(`è¯è¡¨ç´¢å¼•è¶…å‡ºèŒƒå›´: ${wordIndex}`);
    }

    chunks.push(wordlist[wordIndex]);
  }

  return chunks.join(" ");
}

// è§„èŒƒåŒ–åŠ©è®°è¯
function normalizeMnemonic(mnemonic) {
  let normalized = mnemonic.trim();
  normalized = normalized.replace(/\s+/g, ' ');
  normalized = normalized.toLowerCase();
  normalized = normalized.normalize('NFKD');
  return normalized;
}

// BIP39: ä»åŠ©è®°è¯ç”Ÿæˆç§å­
async function mnemonicToSeed(mnemonic, passphrase = '') {
  const encoder = new TextEncoder();

  const normalizedMnemonic = normalizeMnemonic(mnemonic);
  const normalizedPassphrase = passphrase.normalize('NFKD');

  const mnemonicBytes = encoder.encode(normalizedMnemonic);
  const saltBytes = encoder.encode('mnemonic' + normalizedPassphrase);

  return pbkdf2HmacSha512(mnemonicBytes, saltBytes, 2048, 64);
}

// RIPEMD160 å®Œæ•´å®ç°
function ripemd160(bytes) {
  const data = ensureUint8Array(bytes);
  const byteLength = data.length;
  const bitLength = byteLength * 8;
  const paddedLength = ((byteLength + 9 + 63) >>> 6) << 6;
  const padded = new Uint8Array(paddedLength);
  padded.set(data);
  padded[byteLength] = 0x80;

  const view = new DataView(padded.buffer);
  view.setUint32(paddedLength - 8, bitLength >>> 0, true);
  view.setUint32(paddedLength - 4, Math.floor(bitLength / 0x100000000), true);

  let h0 = 0x67452301, h1 = 0xEFCDAB89, h2 = 0x98BADCFE, h3 = 0x10325476, h4 = 0xC3D2E1F0;

  const zl = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
              7, 4, 13, 1, 10, 6, 15, 3, 12, 0, 9, 5, 2, 14, 11, 8,
              3, 10, 14, 4, 9, 15, 8, 1, 2, 7, 0, 6, 13, 11, 5, 12,
              1, 9, 11, 10, 0, 8, 12, 4, 13, 3, 7, 15, 14, 5, 6, 2,
              4, 0, 5, 9, 7, 12, 2, 10, 14, 1, 3, 8, 11, 6, 15, 13];

  const zr = [5, 14, 7, 0, 9, 2, 11, 4, 13, 6, 15, 8, 1, 10, 3, 12,
              6, 11, 3, 7, 0, 13, 5, 10, 14, 15, 8, 12, 4, 9, 1, 2,
              15, 5, 1, 3, 7, 14, 6, 9, 11, 8, 12, 2, 10, 0, 4, 13,
              8, 6, 4, 1, 3, 11, 15, 0, 5, 12, 2, 13, 9, 7, 10, 14,
              12, 15, 10, 4, 1, 5, 8, 7, 6, 2, 13, 14, 0, 3, 9, 11];

  const sl = [11, 14, 15, 12, 5, 8, 7, 9, 11, 13, 14, 15, 6, 7, 9, 8,
              7, 6, 8, 13, 11, 9, 7, 15, 7, 12, 15, 9, 11, 7, 13, 12,
              11, 13, 6, 7, 14, 9, 13, 15, 14, 8, 13, 6, 5, 12, 7, 5,
              11, 12, 14, 15, 14, 15, 9, 8, 9, 14, 5, 6, 8, 6, 5, 12,
              9, 15, 5, 11, 6, 8, 13, 12, 5, 12, 13, 14, 11, 8, 5, 6];

  const sr = [8, 9, 9, 11, 13, 15, 15, 5, 7, 7, 8, 11, 14, 14, 12, 6,
              9, 13, 15, 7, 12, 8, 9, 11, 7, 7, 12, 7, 6, 15, 13, 11,
              9, 7, 15, 11, 8, 6, 6, 14, 12, 13, 5, 14, 13, 13, 7, 5,
              15, 5, 8, 11, 14, 14, 6, 14, 6, 9, 12, 9, 12, 5, 15, 8,
              8, 5, 12, 9, 12, 5, 14, 6, 8, 13, 6, 5, 15, 13, 11, 11];

  const f = (j, x, y, z) => {
    if (j < 16) return x ^ y ^ z;
    if (j < 32) return (x & y) | (~x & z);
    if (j < 48) return (x | ~y) ^ z;
    if (j < 64) return (x & z) | (y & ~z);
    return x ^ (y | ~z);
  };

  const rol = (n, b) => (n << b) | (n >>> (32 - b));

  const X = new Uint32Array(16);

  for (let offset = 0; offset < paddedLength; offset += 64) {
    for (let i = 0; i < 16; i++) {
      X[i] = view.getUint32(offset + i * 4, true);
    }

    let al = h0, bl = h1, cl = h2, dl = h3, el = h4;
    let ar = h0, br = h1, cr = h2, dr = h3, er = h4;

    for (let j = 0; j < 80; j++) {
      let t = (al + f(j, bl, cl, dl) + X[zl[j]]) >>> 0;
      if (j < 16) t = (t + 0x00000000) >>> 0;
      else if (j < 32) t = (t + 0x5A827999) >>> 0;
      else if (j < 48) t = (t + 0x6ED9EBA1) >>> 0;
      else if (j < 64) t = (t + 0x8F1BBCDC) >>> 0;
      else t = (t + 0xA953FD4E) >>> 0;
      t = (t + el) >>> 0;
      t = rol(t, sl[j]);
      t = (t + bl) >>> 0;
      al = el; el = dl; dl = rol(cl, 10); cl = bl; bl = t;

      t = (ar + f(79 - j, br, cr, dr) + X[zr[j]]) >>> 0;
      if (j < 16) t = (t + 0x50A28BE6) >>> 0;
      else if (j < 32) t = (t + 0x5C4DD124) >>> 0;
      else if (j < 48) t = (t + 0x6D703EF3) >>> 0;
      else if (j < 64) t = (t + 0x7A6D76E9) >>> 0;
      else t = (t + 0x00000000) >>> 0;
      t = (t + er) >>> 0;
      t = rol(t, sr[j]);
      t = (t + br) >>> 0;
      ar = er; er = dr; dr = rol(cr, 10); cr = br; br = t;
    }

    const t = (h1 + cl + dr) >>> 0;
    h1 = (h2 + dl + er) >>> 0;
    h2 = (h3 + el + ar) >>> 0;
    h3 = (h4 + al + br) >>> 0;
    h4 = (h0 + bl + cr) >>> 0;
    h0 = t;
  }

  const result = new Uint8Array(20);
  const resultView = new DataView(result.buffer);
  resultView.setUint32(0, h0, true);
  resultView.setUint32(4, h1, true);
  resultView.setUint32(8, h2, true);
  resultView.setUint32(12, h3, true);
  resultView.setUint32(16, h4, true);

  return result;
}

// Bech32 å®Œæ•´å®ç°
function bech32Polymod(values) {
  const GENERATOR = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
  let chk = 1;
  for (const value of values) {
    const top = chk >>> 25;
    chk = (chk & 0x1ffffff) << 5 ^ value;
    for (let i = 0; i < 5; i++) {
      if ((top >>> i) & 1) {
        chk ^= GENERATOR[i];
      }
    }
  }
  return chk;
}

function bech32HrpExpand(hrp) {
  const result = [];
  for (let i = 0; i < hrp.length; i++) {
    result.push(hrp.charCodeAt(i) >>> 5);
  }
  result.push(0);
  for (let i = 0; i < hrp.length; i++) {
    result.push(hrp.charCodeAt(i) & 31);
  }
  return result;
}

function bech32CreateChecksum(hrp, data) {
  const values = bech32HrpExpand(hrp).concat(data).concat([0, 0, 0, 0, 0, 0]);
  const polymod = bech32Polymod(values) ^ 1;
  const checksum = [];
  for (let i = 0; i < 6; i++) {
    checksum.push((polymod >>> (5 * (5 - i))) & 31);
  }
  return checksum;
}

function bech32Encode(hrp, data) {
  const charset = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';
  const checksum = bech32CreateChecksum(hrp, data);
  const combined = data.concat(checksum);
  let result = hrp + '1';
  for (const d of combined) {
    result += charset[d];
  }
  return result;
}

function convertBits(data, fromBits, toBits, pad) {
  let acc = 0;
  let bits = 0;
  const result = [];
  const maxv = (1 << toBits) - 1;

  for (const value of data) {
    acc = (acc << fromBits) | value;
    bits += fromBits;
    while (bits >= toBits) {
      bits -= toBits;
      result.push((acc >>> bits) & maxv);
    }
  }

  if (pad) {
    if (bits > 0) {
      result.push((acc << (toBits - bits)) & maxv);
    }
  } else if (bits >= fromBits || ((acc << (toBits - bits)) & maxv)) {
    throw new Error('Invalid bits conversion');
  }

  return result;
}

function encodeBech32Address(hrp, witnessVersion, witnessProgram) {
  const data = [witnessVersion].concat(convertBits(witnessProgram, 8, 5, true));
  return bech32Encode(hrp, data);
}

// ============ secp256k1 æ¤­åœ†æ›²çº¿å®Œæ•´å®ç° ============

// secp256k1 æ›²çº¿å‚æ•°
const SECP256K1_P = [
  0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF,
  0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFE, 0xFFFFFC2F
];

const SECP256K1_N = [
  0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFE,
  0xBAAEDCE6, 0xAF48A03B, 0xBFD25E8C, 0xD0364141
];

const SECP256K1_GX = [
  0x79BE667E, 0xF9DCBBAC, 0x55A06295, 0xCE870B07,
  0x029BFCDB, 0x2DCE28D9, 0x59F2815B, 0x16F81798
];

const SECP256K1_GY = [
  0x483ADA77, 0x26A3C465, 0x5DA4FBFC, 0x0E1108A8,
  0xFD17B448, 0xA6855419, 0x9C47D08F, 0xFB10D4B8
];

// å¤§æ•´æ•°å·¥å…·å‡½æ•°ï¼ˆ256ä½ï¼‰
function bigIntFromBytes(bytes) {
  const result = new Array(8).fill(0);
  for (let i = 0; i < 8; i++) {
    result[i] = (bytes[i * 4] << 24) | (bytes[i * 4 + 1] << 16) |
                (bytes[i * 4 + 2] << 8) | bytes[i * 4 + 3];
  }
  return result;
}

function bigIntToBytes(bigInt) {
  const result = new Uint8Array(32);
  for (let i = 0; i < 8; i++) {
    result[i * 4] = (bigInt[i] >>> 24) & 0xFF;
    result[i * 4 + 1] = (bigInt[i] >>> 16) & 0xFF;
    result[i * 4 + 2] = (bigInt[i] >>> 8) & 0xFF;
    result[i * 4 + 3] = bigInt[i] & 0xFF;
  }
  return result;
}

function bigIntCopy(a) {
  return [...a];
}

function bigIntIsZero(a) {
  return a.every(x => x === 0);
}

function bigIntCmp(a, b) {
  for (let i = 0; i < 8; i++) {
    if (a[i] !== b[i]) {
      return (a[i] >>> 0) < (b[i] >>> 0) ? -1 : 1;
    }
  }
  return 0;
}

function bigIntAdd(a, b) {
  const result = new Array(8);
  let carry = 0;
  for (let i = 7; i >= 0; i--) {
    const sum = (a[i] >>> 0) + (b[i] >>> 0) + carry;
    result[i] = sum & 0xFFFFFFFF;
    carry = Math.floor(sum / 0x100000000);
  }
  return result;
}

function bigIntSub(a, b) {
  const result = new Array(8);
  let borrow = 0;
  for (let i = 7; i >= 0; i--) {
    const diff = (a[i] >>> 0) - (b[i] >>> 0) - borrow;
    result[i] = diff >>> 0;
    borrow = diff < 0 ? 1 : 0;
  }
  return result;
}

function bigIntModP(a) {
  while (bigIntCmp(a, SECP256K1_P) >= 0) {
    a = bigIntSub(a, SECP256K1_P);
  }
  return a;
}

function bigIntAddMod(a, b, mod) {
  let result = bigIntAdd(a, b);
  while (bigIntCmp(result, mod) >= 0) {
    result = bigIntSub(result, mod);
  }
  return result;
}

function bigIntSubMod(a, b, mod) {
  let result;
  if (bigIntCmp(a, b) >= 0) {
    result = bigIntSub(a, b);
  } else {
    result = bigIntAdd(bigIntSub(mod, b), a);
  }
  return result;
}

function bigIntMulMod(a, b, mod) {
  let result = new Array(8).fill(0);
  let temp = bigIntCopy(a);

  for (let i = 7; i >= 0; i--) {
    for (let j = 0; j < 32; j++) {
      if ((b[i] >>> j) & 1) {
        result = bigIntAddMod(result, temp, mod);
      }
      temp = bigIntAddMod(temp, temp, mod);
    }
  }
  return result;
}

// ä½¿ç”¨è´¹é©¬å°å®šç†è®¡ç®—æ¨¡é€†: a^(-1) = a^(p-2) mod p
function bigIntInvMod(a, mod) {
  // è®¡ç®— mod - 2
  const exp = bigIntSub(mod, [0, 0, 0, 0, 0, 0, 0, 2]);

  // ä½¿ç”¨å¿«é€Ÿå¹‚ç®—æ³•è®¡ç®— a^exp mod mod
  let result = new Array(8).fill(0);
  result[7] = 1;
  let base = bigIntCopy(a);

  for (let i = 7; i >= 0; i--) {
    for (let j = 0; j < 32; j++) {
      if ((exp[i] >>> j) & 1) {
        result = bigIntMulMod(result, base, mod);
      }
      base = bigIntMulMod(base, base, mod);
    }
  }

  return result;
}

// æ¤­åœ†æ›²çº¿ç‚¹ç±»
class Point {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.isInfinity = x === null && y === null;
  }

  static infinity() {
    return new Point(null, null);
  }

  add(other) {
    if (this.isInfinity) return other;
    if (other.isInfinity) return this;

    if (this.x.every((v, i) => v === other.x[i])) {
      if (this.y.every((v, i) => v === other.y[i])) {
        return this.double();
      } else {
        return Point.infinity();
      }
    }

    const dx = bigIntSubMod(other.x, this.x, SECP256K1_P);
    const dy = bigIntSubMod(other.y, this.y, SECP256K1_P);
    const dxInv = bigIntInvMod(dx, SECP256K1_P);
    const m = bigIntMulMod(dy, dxInv, SECP256K1_P);

    const x3 = bigIntSubMod(bigIntSubMod(bigIntMulMod(m, m, SECP256K1_P), this.x, SECP256K1_P), other.x, SECP256K1_P);
    const y3 = bigIntSubMod(bigIntMulMod(m, bigIntSubMod(this.x, x3, SECP256K1_P), SECP256K1_P), this.y, SECP256K1_P);

    return new Point(x3, y3);
  }

  double() {
    if (this.isInfinity) return this;

    const three = [0, 0, 0, 0, 0, 0, 0, 3];
    const two = [0, 0, 0, 0, 0, 0, 0, 2];

    const x2 = bigIntMulMod(this.x, this.x, SECP256K1_P);
    const threeX2 = bigIntMulMod(three, x2, SECP256K1_P);
    const twoY = bigIntMulMod(two, this.y, SECP256K1_P);
    const twoYInv = bigIntInvMod(twoY, SECP256K1_P);
    const m = bigIntMulMod(threeX2, twoYInv, SECP256K1_P);

    const x3 = bigIntSubMod(bigIntMulMod(m, m, SECP256K1_P), bigIntMulMod(two, this.x, SECP256K1_P), SECP256K1_P);
    const y3 = bigIntSubMod(bigIntMulMod(m, bigIntSubMod(this.x, x3, SECP256K1_P), SECP256K1_P), this.y, SECP256K1_P);

    return new Point(x3, y3);
  }

  multiply(scalar) {
    if (this.isInfinity) return this;

    let result = Point.infinity();
    let started = false;

    // ä»æœ€é«˜ä½åˆ°æœ€ä½ä½å¤„ç†ï¼ˆåŒå€åŠ ç®—æ³•ï¼‰
    for (let i = 0; i < 8; i++) {
      for (let j = 31; j >= 0; j--) {
        const bit = (scalar[i] >>> j) & 1;

        if (!started) {
          if (bit === 1) {
            started = true;
            result = this;
          }
          continue;
        }

        result = result.double();
        if (bit === 1) {
          result = result.add(this);
        }
      }
    }

    return result;
  }
}

// ä»ç§é’¥ç”Ÿæˆå‹ç¼©å…¬é’¥
function privateKeyToCompressedPublicKey(privateKey) {
  const privateKeyBigInt = bigIntFromBytes(privateKey);

  // ç”Ÿæˆå™¨ç‚¹ G
  const G = new Point(SECP256K1_GX, SECP256K1_GY);

  // è®¡ç®—å…¬é’¥ç‚¹ P = privateKey * G
  const publicKeyPoint = G.multiply(privateKeyBigInt);

  if (publicKeyPoint.isInfinity) {
    throw new Error('Invalid private key: results in point at infinity');
  }

  // å‹ç¼©å…¬é’¥æ ¼å¼: 0x02/0x03 + xåæ ‡
  const result = new Uint8Array(33);
  const xBytes = bigIntToBytes(publicKeyPoint.x);

  // æ ¹æ®yåæ ‡çš„å¥‡å¶æ€§é€‰æ‹©å‰ç¼€
  const yIsOdd = (publicKeyPoint.y[7] & 1) === 1;
  result[0] = yIsOdd ? 0x03 : 0x02;
  result.set(xBytes, 1);

  return result;
}

// ============ BIP32 HD é’±åŒ…æ´¾ç”Ÿå®Œæ•´å®ç° ============

// BIP32 æ´¾ç”Ÿè·¯å¾„è§£æ
function parseBIP32Path(path) {
  if (!path.startsWith('m/')) {
    throw new Error('Invalid BIP32 path: must start with m/');
  }

  const segments = path.slice(2).split('/');
  const indices = [];

  for (const segment of segments) {
    let index;
    let hardened = false;

    if (segment.endsWith("'") || segment.endsWith('h')) {
      hardened = true;
      index = parseInt(segment.slice(0, -1));
    } else {
      index = parseInt(segment);
    }

    if (isNaN(index) || index < 0) {
      throw new Error(`Invalid BIP32 path segment: ${segment}`);
    }

    // ç¡¬åŒ–æ´¾ç”Ÿ: åŠ ä¸Š 2^31
    indices.push(hardened ? index + 0x80000000 : index);
  }

  return indices;
}

// BIP32 ä¸»å¯†é’¥æ´¾ç”Ÿ
async function deriveMasterKey(seed) {
  const hmacKey = stringToBytes('Bitcoin seed');
  const I = await hmacSha512(hmacKey, seed);

  const IL = I.slice(0, 32);  // ä¸»ç§é’¥
  const IR = I.slice(32, 64); // ä¸»é“¾ç 

  return { privateKey: IL, chainCode: IR };
}

// BIP32 å­å¯†é’¥æ´¾ç”Ÿï¼ˆCKDå‡½æ•°ï¼‰
async function deriveChildKey(parentKey, parentChainCode, index) {
  const hardened = (index >= 0x80000000);

  let data;
  if (hardened) {
    // ç¡¬åŒ–æ´¾ç”Ÿ: ä½¿ç”¨ 0x00 || çˆ¶ç§é’¥ || index
    data = new Uint8Array(37);
    data[0] = 0x00;
    data.set(parentKey, 1);
    data[32] = (index >>> 24) & 0xFF;
    data[33] = (index >>> 16) & 0xFF;
    data[34] = (index >>> 8) & 0xFF;
    data[35] = index & 0xFF;
  } else {
    // éç¡¬åŒ–æ´¾ç”Ÿ: ä½¿ç”¨çˆ¶å…¬é’¥ || index
    const parentPublicKey = privateKeyToCompressedPublicKey(parentKey);
    data = new Uint8Array(37);
    data.set(parentPublicKey, 0);
    data[33] = (index >>> 24) & 0xFF;
    data[34] = (index >>> 16) & 0xFF;
    data[35] = (index >>> 8) & 0xFF;
    data[36] = index & 0xFF;
  }

  const I = await hmacSha512(parentChainCode, data);

  const IL = I.slice(0, 32);
  const IR = I.slice(32, 64);

  // è®¡ç®—å­ç§é’¥: (IL + çˆ¶ç§é’¥) mod n
  const ILBigInt = bigIntFromBytes(IL);
  const parentKeyBigInt = bigIntFromBytes(parentKey);
  const childKeyBigInt = bigIntAddMod(ILBigInt, parentKeyBigInt, SECP256K1_N);

  // æ£€æŸ¥æ˜¯å¦ä¸ºé›¶ï¼ˆæä½æ¦‚ç‡ï¼‰
  if (bigIntIsZero(childKeyBigInt)) {
    throw new Error('Invalid child key: resulted in zero');
  }

  const childKey = bigIntToBytes(childKeyBigInt);
  const childChainCode = IR;

  return { privateKey: childKey, chainCode: childChainCode };
}

// BIP32 å®Œæ•´è·¯å¾„æ´¾ç”Ÿ
async function deriveBIP32Path(seed, path) {
  const indices = parseBIP32Path(path);
  let { privateKey, chainCode } = await deriveMasterKey(seed);

  for (const index of indices) {
    const result = await deriveChildKey(privateKey, chainCode, index);
    privateKey = result.privateKey;
    chainCode = result.chainCode;
  }

  return { privateKey, chainCode };
}

// æ¯”ç‰¹å¸åœ°å€ç”Ÿæˆï¼ˆä½¿ç”¨ BIP32 æ´¾ç”Ÿï¼‰
async function generateBitcoinAddress(mnemonic, passphrase = '') {
  try {
    console.log('å¼€å§‹ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€...');

    // 1. ä»åŠ©è®°è¯ç”Ÿæˆç§å­
    console.log('æ­¥éª¤ 1: ç”Ÿæˆç§å­');
    const seed = await mnemonicToSeed(mnemonic, passphrase);
    console.log('ç§å­ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦:', seed.length);

    // 2. ä½¿ç”¨ BIP32 æ´¾ç”Ÿè·¯å¾„ m/84'/0'/0'/0/0 (Native SegWit)
    console.log('æ­¥éª¤ 2: BIP32 æ´¾ç”Ÿ');
    const { privateKey } = await deriveBIP32Path(seed, "m/84'/0'/0'/0/0");
    console.log('ç§é’¥æ´¾ç”ŸæˆåŠŸ');

    // 3. ç”Ÿæˆå‹ç¼©å…¬é’¥
    console.log('æ­¥éª¤ 3: ç”Ÿæˆå…¬é’¥');
    const publicKey = privateKeyToCompressedPublicKey(privateKey);
    console.log('å…¬é’¥ç”ŸæˆæˆåŠŸ:', Array.from(publicKey.slice(0, 10)).map(b => b.toString(16).padStart(2, '0')).join('') + '...');

    // 4. è®¡ç®—å…¬é’¥å“ˆå¸Œ (SHA256 -> RIPEMD160)
    console.log('æ­¥éª¤ 4: è®¡ç®—å…¬é’¥å“ˆå¸Œ');
    const sha256Hash = await sha256Bytes(publicKey);
    console.log('SHA256 å®Œæˆ');
    const pubKeyHash = ripemd160(sha256Hash);
    console.log('RIPEMD160 å®Œæˆï¼Œå“ˆå¸Œé•¿åº¦:', pubKeyHash.length);

    // 5. ä½¿ç”¨ Bech32 ç¼–ç ç”Ÿæˆ Native SegWit åœ°å€
    console.log('æ­¥éª¤ 5: Bech32 ç¼–ç ');
    const witnessVersion = 0;
    const address = encodeBech32Address('bc', witnessVersion, Array.from(pubKeyHash));
    console.log('åœ°å€ç”ŸæˆæˆåŠŸ:', address);

    return address;
  } catch (error) {
    console.error('ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€å¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯:', error);
    console.error('é”™è¯¯å †æ ˆ:', error.stack);
    throw error;
  }
}

// ç”ŸæˆæŒ‰é’®äº‹ä»¶å¤„ç†
btnGenerate.addEventListener("click", async () => {
  showLoading(btnGenerate);
  mnemonicDiv.textContent = "";
  mnemonicDiv.classList.add('generating');

  // æ·»åŠ å»¶è¿Ÿä»¥æ˜¾ç¤ºåŠ¨ç”»æ•ˆæœ
  await new Promise(resolve => setTimeout(resolve, 500));

  try {
    // ç”Ÿæˆç†µ
    const entropy = generateEntropy(wordCount === 12 ? 16 : 32);

    // éªŒè¯ç†µä¸ä¸ºå…¨0
    const allZero = entropy.every(b => b === 0);
    if (allZero) {
      throw new Error('ç”Ÿæˆçš„ç†µä¸ºå…¨0ï¼Œè¯·é‡è¯•');
    }

    // ç”ŸæˆåŠ©è®°è¯
    const mnemonic = await entropyToMnemonic(entropy, EMBEDDED_BIP39_WORDLIST);

    // æ¸…é›¶ç†µï¼ˆå®‰å…¨æªæ–½ï¼‰
    for (let i = 0; i < entropy.length; i++) {
      entropy[i] = 0;
    }

    hideLoading(btnGenerate);
    mnemonicDiv.classList.remove('generating');

    // é€ä¸ªå•è¯æ˜¾ç¤ºåŠ¨ç”»
    const words = mnemonic.split(' ');
    mnemonicDiv.textContent = '';

    for (let i = 0; i < words.length; i++) {
      const wordSpan = document.createElement('span');
      wordSpan.textContent = words[i].toLowerCase();
      wordSpan.style.opacity = '0';
      wordSpan.style.transform = 'translateY(10px)';
      wordSpan.style.transition = `all 0.2s ease ${i * 50}ms`;

      mnemonicDiv.appendChild(wordSpan);

      setTimeout(() => {
        wordSpan.style.opacity = '1';
        wordSpan.style.transform = 'translateY(0)';
      }, 10);
    }

    // ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€
    btcAddressInput.value = "è®¡ç®—ä¸­...";
    addressSection.style.display = 'block';

    try {
      const address = await generateBitcoinAddress(mnemonic, '');
      btcAddressInput.value = address;
    } catch (e) {
      console.error("ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€å¤±è´¥:", e);
      btcAddressInput.value = "åœ°å€ç”Ÿæˆå¤±è´¥";
    }
  } catch (error) {
    hideLoading(btnGenerate);
    mnemonicDiv.classList.remove('generating');
    const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';

    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff6b6b;
      color: white;
      padding: 15px;
      border-radius: 5px;
      max-width: 300px;
      z-index: 9999;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    errorDiv.innerHTML = `<strong>ç”Ÿæˆå¤±è´¥ï¼š</strong>${errorMsg}`;
    document.body.appendChild(errorDiv);

    setTimeout(() => {
      if (errorDiv.parentNode) {
        errorDiv.parentNode.removeChild(errorDiv);
      }
    }, 5000);

    console.error("ç”ŸæˆåŠ©è®°è¯å¤±è´¥:", errorMsg);
    mnemonicDiv.textContent = "";
    btcAddressInput.value = "";
    addressSection.style.display = 'none';
  }
});

// æ¸…é™¤æŒ‰é’®äº‹ä»¶å¤„ç†
btnClear.addEventListener("click", () => {
  // æ¸…é™¤æ˜¾ç¤ºçš„å†…å®¹
  mnemonicDiv.textContent = "";
  btcAddressInput.value = "";
  addressSection.style.display = 'none';

  // æ³¨æ„ï¼šæ•æ„Ÿæ•°æ®ï¼ˆç†µã€ç§é’¥ã€ç§å­ç­‰ï¼‰å·²åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­é€šè¿‡ secureWipe() æ¸…é›¶
  // è¿™äº›æ•°æ®å­˜å‚¨åœ¨å‡½æ•°ä½œç”¨åŸŸå†…ï¼Œä¼šè¢«åƒåœ¾å›æ”¶å™¨è‡ªåŠ¨æ¸…ç†

  // æ·»åŠ æ¸…é™¤åŠ¨ç”»
  mnemonicDiv.classList.add('cleared');
  setTimeout(() => {
    mnemonicDiv.classList.remove('cleared');
  }, 500);
});

// å¤åˆ¶åœ°å€æŒ‰é’®åŠŸèƒ½
btnCopyAddress.addEventListener("click", async () => {
  const address = btcAddressInput.value.trim();
  if (!address || address === "è®¡ç®—ä¸­..." || address.startsWith("åœ°å€ç”Ÿæˆå¤±è´¥")) {
    return;
  }

  try {
    await navigator.clipboard.writeText(address);
    const originalText = btnCopyAddress.textContent;
    btnCopyAddress.textContent = "âœ“ å·²å¤åˆ¶";
    btnCopyAddress.style.background = "var(--success)";

    setTimeout(() => {
      btnCopyAddress.textContent = originalText;
      btnCopyAddress.style.background = "";
    }, 2000);
  } catch (e) {
    // é™çº§æ–¹æ¡ˆï¼šé€‰æ‹©æ–‡æœ¬
    btcAddressInput.select();
    btcAddressInput.setSelectionRange(0, 99999);
    try {
      document.execCommand('copy');
      const originalText = btnCopyAddress.textContent;
      btnCopyAddress.textContent = "âœ“ å·²å¤åˆ¶";
      setTimeout(() => {
        btnCopyAddress.textContent = originalText;
      }, 2000);
    } catch (err) {
      alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶");
    }
  }
});

// ========== éšç§æ¨¡å¼è®¾ç½® ==========
// å¯ç”¨éšç§æ¨¡å¼ï¼šç¦ç”¨ localStorage ä»¥é˜²æ­¢æ•°æ®æ³„éœ²
const PRIVACY_MODE = true;

// å®‰å…¨çš„ localStorage åŒ…è£…å™¨
const secureStorage = {
  getItem: (key) => {
    if (PRIVACY_MODE) return null;
    try {
      return localStorage.getItem(key);
    } catch (e) {
      console.warn('localStorage access denied:', e);
      return null;
    }
  },
  setItem: (key, value) => {
    if (PRIVACY_MODE) return;
    try {
      localStorage.setItem(key, value);
    } catch (e) {
      console.warn('localStorage write denied:', e);
    }
  }
};

// ========== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ==========
const htmlElement = document.documentElement;
const themeToggle = document.getElementById('theme-toggle');
const sunIcon = document.getElementById('sun-icon');
const moonIcon = document.getElementById('moon-icon');

function getInitialTheme() {
  const saved = secureStorage.getItem('theme');
  if (saved) return saved;
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    return 'dark';
  }
  return 'light';
}

function setTheme(theme) {
  if (theme === 'dark') {
    htmlElement.setAttribute('data-theme', 'dark');
    sunIcon.style.display = 'block';
    moonIcon.style.display = 'none';
    secureStorage.setItem('theme', 'dark');
  } else {
    htmlElement.removeAttribute('data-theme');
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'block';
    secureStorage.setItem('theme', 'light');
  }
}

// åˆå§‹åŒ–ä¸»é¢˜
setTheme(getInitialTheme());

// ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
themeToggle.addEventListener('click', () => {
  const currentTheme = htmlElement.getAttribute('data-theme');
  setTheme(currentTheme === 'dark' ? 'light' : 'dark');
});

// ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!secureStorage.getItem('theme')) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });
}

// é¡µé¢åŠ è½½å®ŒæˆåŠ¨ç”»
document.addEventListener('DOMContentLoaded', () => {
  document.body.classList.add('loaded');
});

// ========== é¡µé¢å…³é—­è­¦å‘Š ==========
// é˜²æ­¢ç”¨æˆ·æ„å¤–å…³é—­é¡µé¢å¯¼è‡´æœªä¿å­˜çš„åŠ©è®°è¯ä¸¢å¤±
let hasSensitiveData = false;

// å½“ç”ŸæˆåŠ©è®°è¯æ—¶æ ‡è®°æœ‰æ•æ„Ÿæ•°æ®
const originalGenerateHandler = btnGenerate;
btnGenerate.addEventListener('click', () => {
  hasSensitiveData = true;
}, true);

// å½“æ¸…é™¤æ—¶å–æ¶ˆæ ‡è®°
const originalClearHandler = btnClear;
btnClear.addEventListener('click', () => {
  hasSensitiveData = false;
}, true);

// ç›‘å¬é¡µé¢å…³é—­äº‹ä»¶
window.addEventListener('beforeunload', (event) => {
  if (hasSensitiveData && mnemonicDiv.textContent.trim().length > 0) {
    // ç°ä»£æµè§ˆå™¨ä¼šå¿½ç•¥è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œä½†ä»éœ€è®¾ç½® returnValue
    const message = 'é¡µé¢åŒ…å«æ•æ„Ÿçš„åŠ©è®°è¯ä¿¡æ¯ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿè¯·ç¡®ä¿å·²å®‰å…¨ä¿å­˜æ‚¨çš„åŠ©è®°è¯ï¼';
    event.preventDefault();
    event.returnValue = message;
    return message;
  }
});

// ========== æµ‹è¯•å‡½æ•°ï¼ˆåœ¨æ§åˆ¶å°è¿è¡Œ testSecp256k1() æ¥éªŒè¯ï¼‰ ==========
window.testSecp256k1 = function() {
  console.log('å¼€å§‹æµ‹è¯• secp256k1...');

  // æµ‹è¯• 1: ç§é’¥ = 1 åº”è¯¥å¾—åˆ°ç”Ÿæˆå™¨ç‚¹ G
  const testKey1 = new Uint8Array(32);
  testKey1[31] = 1;

  try {
    const pubKey1 = privateKeyToCompressedPublicKey(testKey1);
    const pubKey1Hex = Array.from(pubKey1).map(b => b.toString(16).padStart(2, '0')).join('');

    // æœŸæœ›å€¼ï¼šå‹ç¼©å…¬é’¥å‰ç¼€ 02 æˆ– 03 + Gx
    const expectedGx = '79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798';
    const actualGx = pubKey1Hex.slice(2);

    console.log('æµ‹è¯• 1 - ç§é’¥ = 1:');
    console.log('  å…¬é’¥:', pubKey1Hex);
    console.log('  æœŸæœ› Gx:', expectedGx);
    console.log('  å®é™… Gx:', actualGx);
    console.log('  ç»“æœ:', actualGx === expectedGx ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥');

    // æµ‹è¯• 2: å·²çŸ¥çš„æµ‹è¯•å‘é‡
    const testKey2 = new Uint8Array(32);
    for (let i = 0; i < 32; i++) testKey2[i] = i + 1;

    const pubKey2 = privateKeyToCompressedPublicKey(testKey2);
    const pubKey2Hex = Array.from(pubKey2).map(b => b.toString(16).padStart(2, '0')).join('');
    console.log('\næµ‹è¯• 2 - ç§é’¥ = 0102...1f20:');
    console.log('  å…¬é’¥:', pubKey2Hex);

    return 'âœ… æµ‹è¯•å®Œæˆï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„è¾“å‡º';
  } catch (e) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', e);
    console.error('é”™è¯¯å †æ ˆ:', e.stack);
    return 'âŒ æµ‹è¯•å¤±è´¥: ' + e.message;
  }
};

console.log('ğŸ”’ å®Œæ•´ä¿®å¤ç‰ˆå·²åŠ è½½å®Œæˆï¼Œæ‰€æœ‰äº¤äº’åŠŸèƒ½å·²ä¿®å¤');
console.log('ğŸ’¡ åœ¨æ§åˆ¶å°è¿è¡Œ testSecp256k1() æ¥æµ‹è¯•æ¤­åœ†æ›²çº¿å®ç°');
</script>

</body>
</html>